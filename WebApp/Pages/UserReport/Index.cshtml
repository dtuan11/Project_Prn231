@page
@model WebApp.Pages.UserReport.IndexModel
@{
}
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Colorlib Templates">
    <meta name="author" content="Colorlib">
    <meta name="keywords" content="Colorlib Templates">

    <!-- Title Page-->
    <title>Au Register Forms by Colorlib</title>

    <!-- Icons font CSS-->
    <link href="~/css/vendor/mdi-font/material-design-iconic-font.min.css" rel="stylesheet" media="all">
    <link href="~/css/vendor/font-awesome-4.7/font-awesome.min.css" rel="stylesheet" media="all">
    <!-- Font special for pages-->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">

    <!-- Vendor CSS-->
    <link href="~/css/vendor/select2/select2.min.css" rel="stylesheet" media="all">
    <link href="~/css/vendor/datepicker/daterangepicker.css" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="~/css/main.css" rel="stylesheet" media="all">
</head>
<body>
    <div class="page-wrapper bg-gra-03 p-t-45 p-b-50">
        <div class="wrapper wrapper--w790">
            <div class="card card-5">
                <div class="card-heading">
                    <h2 class="title">Send FeedBack</h2>
                </div>
                <div class="card-body">
                    <form id="report-form" onsubmit="submitReport(event)">
                        <div class="form-row">
                            <div class="name">Book Name</div>
                            <div class="value">
                                <div class="input-group">
                                    <input id="book-name" class="input--style-5" type="text" name="bookName" readonly />
                                    <input id="book-id" hidden class="input--style-5" type="text" name="bookId" readonly value="@Model.BookId" />
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="name">Report Type</div>
                            <div class="value">
                                <div class="input-group">
                                    <div class="rs-select2 js-select-simple select--no-search">
                                        <select id="report-type" name="report" required></select>
                                        <div class="select-dropdown"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="name">Chapter</div>
                            <div class="value">
                                <div class="input-group">
                                    <input id="chapter" class="input--style-5" type="number" name="chapter" min="1" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="name">Description</div>
                            <div class="value">
                                <div class="input-group">
                                    <textarea id="description" style="background-color: #e5e5e5" name="description" rows="5" cols="10" minlength="10" maxlength="100" required></textarea>
                                </div>
                            </div>
                        </div>
                        <div>
                            <button style="background-color: red; margin-left:10%; color: white" class="btn btn--radius-2 btn--red" type="submit">Send</button>
                            <a asp-page="/Homepage/BookDetail" asp-route-id="@Model.BookId" action style="background-color: red; margin-left:40%; color: white" class="btn btn--radius-2 btn--red">Cancel</a>
                        </div>
                    </form>
                    
                    <script>
                        const bookId = @Model.BookId;
                        const userId = '@Model.UserId' || null;

                        async function fetchReportFormData(bookId) {
                            try {
                                const response = await fetch(`https://localhost:7186/api/reports/${bookId}`);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! Status: ${response.status}`);
                                }
                                const data = await response.json();
                                renderFormData(data);
                            } catch (error) {
                                console.error('Error fetching report form data:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to load report form data.'
                                });
                            }
                        }

                        function renderFormData(data) {
                            document.getElementById('book-name').value = data.bookTitle;
                            const reportTypeSelect = document.getElementById('report-type');
                            reportTypeSelect.innerHTML = '';
                            data.reportTypes.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                reportTypeSelect.appendChild(option);
                            });
                        }

                        async function submitReport(event) {
                            event.preventDefault();
                            const reportData = {
                                bookId: parseInt(document.getElementById('book-id').value),
                                reportType: document.getElementById('report-type').value,
                                chapter: parseInt(document.getElementById('chapter').value),
                                description: document.getElementById('description').value,
                                userId: userId ? parseInt(userId) : null
                            };

                            try {
                                const response = await fetch('https://localhost:7186/api/reports', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(reportData)
                                });

                                const result = await response.json();
                                if (result.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success',
                                        text: result.message
                                    }).then(() => {
                                        window.location.href = `/Homepage/BookDetail?id=${bookId}`;
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: result.message
                                    });
                                }
                            } catch (error) {
                                console.error('Error submitting report:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to submit report.'
                                });
                            }
                        }

                        // Load form data on page load
                        fetchReportFormData(bookId);
                    </script>

                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Jquery JS-->
    <script src="~/css/vendor/jquery/jquery.min.js"></script>
    <!-- Vendor JS-->
    <script src="~/css/vendor/select2/select2.min.js"></script>
    <script src="~/css/vendor/datepicker/moment.min.js"></script>
    <script src="~/css/vendor/datepicker/daterangepicker.js"></script>

    <!-- Main JS-->
    <script src="js/global.js"></script>

</body><!-- This templates was made by Colorlib (https://colorlib.com) -->

</html>